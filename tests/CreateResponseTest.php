<?php

declare(strict_types=1);

namespace Firehed\WebAuthn;

/**
 * @coversDefaultClass Firehed\WebAuthn\CreateResponse
 * @covers ::<protected>
 * @covers ::<private>
 */
class CreateResponseTest extends \PHPUnit\Framework\TestCase
{
    private RelyingParty $rp;

    private Challenge $challenge;

    public function setUp(): void
    {
        $this->rp = new RelyingParty('http://localhost:8888');

        $this->challenge = new Challenge(new BinaryString(
            base64_decode('KGDFuirKM+2GsgP7FsznnS9NK3sD9TlNFEqmpvAljbw=', true)
        ));
    }

    // 7.1.7
    public function testCDJTypeMismatchIsError(): void
    {
        // override CDJ
    }

    // 7.1.8
    public function testCDJChallengeMismatchIsError(): void
    {
        // override CDJ
    }

    // 7.1.9
    public function testCDJOriginMismatchIsError(): void
    {
        // override CDJ
    }

    // 7.1.13
    public function testRelyingPartyIdMismatchIsError(): void
    {
        // override authData
    }

    // 7.1.14
    public function testUserNotPresentIsError(): void
    {
        // override authData
    }

    // 7.1.15
    public function testUserVerifiedNotPresentWhenRequiredIsError(): void
    {
        // (default data ok)
        // call verify with UVR::Required
    }

    // 7.1.16
    public function testPubKeyAlgorithmNotMatchingOptionsIsError(): void
    {
        self::markTestSkipped('Only EC2/ED256 supported at this time');
    }

    // 7.1.19
    public function testFormatSpecificVerificationOccurs(): void
    {
        // CreateResponse.ao.stmt
        // = createMock(AttestationStatementInterface::class)
        // ->expects(self::once())
        // ->method('verify')
        // ->with(...)
        // ->willReturn(...)
        //
        // or AO itself gets interfaced and mocked diectly?
    }
    // format-specific tests of verification? these should get tested
        //
    // separately. Need to create an AttestationObject with a mocked


    public function testSuccess(): void
    {
        $json = <<<'JSON'
        {
            "rawId": {
                "0": 236,
                "1": 58,
                "2": 219,
                "3": 22,
                "4": 123,
                "5": 115,
                "6": 98,
                "7": 124,
                "8": 11,
                "9": 0,
                "10": 207,
                "11": 244,
                "12": 106,
                "13": 41,
                "14": 249,
                "15": 202,
                "16": 71,
                "17": 106,
                "18": 58,
                "19": 209,
                "20": 209,
                "21": 243,
                "22": 172,
                "23": 181,
                "24": 172,
                "25": 43,
                "26": 40,
                "27": 230,
                "28": 31,
                "29": 122,
                "30": 155,
                "31": 134,
                "32": 233,
                "33": 100,
                "34": 181,
                "35": 1,
                "36": 244,
                "37": 209,
                "38": 87,
                "39": 196,
                "40": 229,
                "41": 209,
                "42": 179,
                "43": 114,
                "44": 159,
                "45": 228,
                "46": 220,
                "47": 236,
                "48": 239,
                "49": 36,
                "50": 27,
                "51": 45,
                "52": 159,
                "53": 223,
                "54": 209,
                "55": 245,
                "56": 214,
                "57": 39,
                "58": 125,
                "59": 27,
                "60": 143,
                "61": 115,
                "62": 48,
                "63": 36
            },
            "type": "public-key",
            "attestationObject": {
                "0": 163,
                "1": 99,
                "2": 102,
                "3": 109,
                "4": 116,
                "5": 104,
                "6": 102,
                "7": 105,
                "8": 100,
                "9": 111,
                "10": 45,
                "11": 117,
                "12": 50,
                "13": 102,
                "14": 103,
                "15": 97,
                "16": 116,
                "17": 116,
                "18": 83,
                "19": 116,
                "20": 109,
                "21": 116,
                "22": 162,
                "23": 99,
                "24": 115,
                "25": 105,
                "26": 103,
                "27": 88,
                "28": 71,
                "29": 48,
                "30": 69,
                "31": 2,
                "32": 32,
                "33": 125,
                "34": 241,
                "35": 18,
                "36": 179,
                "37": 63,
                "38": 148,
                "39": 87,
                "40": 33,
                "41": 101,
                "42": 87,
                "43": 90,
                "44": 193,
                "45": 184,
                "46": 205,
                "47": 46,
                "48": 140,
                "49": 178,
                "50": 227,
                "51": 125,
                "52": 156,
                "53": 130,
                "54": 101,
                "55": 119,
                "56": 198,
                "57": 219,
                "58": 226,
                "59": 228,
                "60": 245,
                "61": 150,
                "62": 114,
                "63": 202,
                "64": 185,
                "65": 2,
                "66": 33,
                "67": 0,
                "68": 231,
                "69": 58,
                "70": 231,
                "71": 199,
                "72": 193,
                "73": 59,
                "74": 137,
                "75": 101,
                "76": 112,
                "77": 10,
                "78": 118,
                "79": 58,
                "80": 7,
                "81": 87,
                "82": 103,
                "83": 230,
                "84": 182,
                "85": 199,
                "86": 58,
                "87": 172,
                "88": 172,
                "89": 67,
                "90": 207,
                "91": 172,
                "92": 189,
                "93": 216,
                "94": 228,
                "95": 194,
                "96": 202,
                "97": 152,
                "98": 27,
                "99": 111,
                "100": 99,
                "101": 120,
                "102": 53,
                "103": 99,
                "104": 129,
                "105": 89,
                "106": 2,
                "107": 49,
                "108": 48,
                "109": 130,
                "110": 2,
                "111": 45,
                "112": 48,
                "113": 130,
                "114": 1,
                "115": 23,
                "116": 160,
                "117": 3,
                "118": 2,
                "119": 1,
                "120": 2,
                "121": 2,
                "122": 4,
                "123": 5,
                "124": 182,
                "125": 5,
                "126": 121,
                "127": 48,
                "128": 11,
                "129": 6,
                "130": 9,
                "131": 42,
                "132": 134,
                "133": 72,
                "134": 134,
                "135": 247,
                "136": 13,
                "137": 1,
                "138": 1,
                "139": 11,
                "140": 48,
                "141": 46,
                "142": 49,
                "143": 44,
                "144": 48,
                "145": 42,
                "146": 6,
                "147": 3,
                "148": 85,
                "149": 4,
                "150": 3,
                "151": 19,
                "152": 35,
                "153": 89,
                "154": 117,
                "155": 98,
                "156": 105,
                "157": 99,
                "158": 111,
                "159": 32,
                "160": 85,
                "161": 50,
                "162": 70,
                "163": 32,
                "164": 82,
                "165": 111,
                "166": 111,
                "167": 116,
                "168": 32,
                "169": 67,
                "170": 65,
                "171": 32,
                "172": 83,
                "173": 101,
                "174": 114,
                "175": 105,
                "176": 97,
                "177": 108,
                "178": 32,
                "179": 52,
                "180": 53,
                "181": 55,
                "182": 50,
                "183": 48,
                "184": 48,
                "185": 54,
                "186": 51,
                "187": 49,
                "188": 48,
                "189": 32,
                "190": 23,
                "191": 13,
                "192": 49,
                "193": 52,
                "194": 48,
                "195": 56,
                "196": 48,
                "197": 49,
                "198": 48,
                "199": 48,
                "200": 48,
                "201": 48,
                "202": 48,
                "203": 48,
                "204": 90,
                "205": 24,
                "206": 15,
                "207": 50,
                "208": 48,
                "209": 53,
                "210": 48,
                "211": 48,
                "212": 57,
                "213": 48,
                "214": 52,
                "215": 48,
                "216": 48,
                "217": 48,
                "218": 48,
                "219": 48,
                "220": 48,
                "221": 90,
                "222": 48,
                "223": 40,
                "224": 49,
                "225": 38,
                "226": 48,
                "227": 36,
                "228": 6,
                "229": 3,
                "230": 85,
                "231": 4,
                "232": 3,
                "233": 12,
                "234": 29,
                "235": 89,
                "236": 117,
                "237": 98,
                "238": 105,
                "239": 99,
                "240": 111,
                "241": 32,
                "242": 85,
                "243": 50,
                "244": 70,
                "245": 32,
                "246": 69,
                "247": 69,
                "248": 32,
                "249": 83,
                "250": 101,
                "251": 114,
                "252": 105,
                "253": 97,
                "254": 108,
                "255": 32,
                "256": 57,
                "257": 53,
                "258": 56,
                "259": 49,
                "260": 53,
                "261": 48,
                "262": 51,
                "263": 51,
                "264": 48,
                "265": 89,
                "266": 48,
                "267": 19,
                "268": 6,
                "269": 7,
                "270": 42,
                "271": 134,
                "272": 72,
                "273": 206,
                "274": 61,
                "275": 2,
                "276": 1,
                "277": 6,
                "278": 8,
                "279": 42,
                "280": 134,
                "281": 72,
                "282": 206,
                "283": 61,
                "284": 3,
                "285": 1,
                "286": 7,
                "287": 3,
                "288": 66,
                "289": 0,
                "290": 4,
                "291": 253,
                "292": 184,
                "293": 222,
                "294": 179,
                "295": 161,
                "296": 237,
                "297": 112,
                "298": 235,
                "299": 99,
                "300": 108,
                "301": 6,
                "302": 110,
                "303": 182,
                "304": 0,
                "305": 105,
                "306": 150,
                "307": 165,
                "308": 249,
                "309": 112,
                "310": 252,
                "311": 181,
                "312": 219,
                "313": 136,
                "314": 252,
                "315": 59,
                "316": 48,
                "317": 93,
                "318": 65,
                "319": 229,
                "320": 150,
                "321": 111,
                "322": 12,
                "323": 27,
                "324": 84,
                "325": 184,
                "326": 82,
                "327": 254,
                "328": 240,
                "329": 160,
                "330": 144,
                "331": 126,
                "332": 209,
                "333": 127,
                "334": 59,
                "335": 255,
                "336": 194,
                "337": 157,
                "338": 77,
                "339": 50,
                "340": 27,
                "341": 156,
                "342": 248,
                "343": 168,
                "344": 74,
                "345": 44,
                "346": 234,
                "347": 160,
                "348": 56,
                "349": 202,
                "350": 189,
                "351": 53,
                "352": 213,
                "353": 152,
                "354": 222,
                "355": 163,
                "356": 38,
                "357": 48,
                "358": 36,
                "359": 48,
                "360": 34,
                "361": 6,
                "362": 9,
                "363": 43,
                "364": 6,
                "365": 1,
                "366": 4,
                "367": 1,
                "368": 130,
                "369": 196,
                "370": 10,
                "371": 2,
                "372": 4,
                "373": 21,
                "374": 49,
                "375": 46,
                "376": 51,
                "377": 46,
                "378": 54,
                "379": 46,
                "380": 49,
                "381": 46,
                "382": 52,
                "383": 46,
                "384": 49,
                "385": 46,
                "386": 52,
                "387": 49,
                "388": 52,
                "389": 56,
                "390": 50,
                "391": 46,
                "392": 49,
                "393": 46,
                "394": 49,
                "395": 48,
                "396": 11,
                "397": 6,
                "398": 9,
                "399": 42,
                "400": 134,
                "401": 72,
                "402": 134,
                "403": 247,
                "404": 13,
                "405": 1,
                "406": 1,
                "407": 11,
                "408": 3,
                "409": 130,
                "410": 1,
                "411": 1,
                "412": 0,
                "413": 126,
                "414": 211,
                "415": 251,
                "416": 108,
                "417": 204,
                "418": 37,
                "419": 32,
                "420": 19,
                "421": 248,
                "422": 47,
                "423": 33,
                "424": 140,
                "425": 42,
                "426": 55,
                "427": 218,
                "428": 96,
                "429": 49,
                "430": 210,
                "431": 14,
                "432": 127,
                "433": 48,
                "434": 129,
                "435": 218,
                "436": 252,
                "437": 174,
                "438": 177,
                "439": 40,
                "440": 252,
                "441": 127,
                "442": 155,
                "443": 35,
                "444": 57,
                "445": 20,
                "446": 191,
                "447": 182,
                "448": 77,
                "449": 97,
                "450": 53,
                "451": 241,
                "452": 124,
                "453": 226,
                "454": 33,
                "455": 250,
                "456": 118,
                "457": 79,
                "458": 69,
                "459": 62,
                "460": 241,
                "461": 39,
                "462": 58,
                "463": 140,
                "464": 233,
                "465": 101,
                "466": 149,
                "467": 100,
                "468": 66,
                "469": 187,
                "470": 47,
                "471": 30,
                "472": 71,
                "473": 72,
                "474": 63,
                "475": 115,
                "476": 125,
                "477": 203,
                "478": 201,
                "479": 139,
                "480": 88,
                "481": 83,
                "482": 119,
                "483": 254,
                "484": 245,
                "485": 11,
                "486": 39,
                "487": 14,
                "488": 2,
                "489": 137,
                "490": 248,
                "491": 132,
                "492": 54,
                "493": 241,
                "494": 173,
                "495": 207,
                "496": 73,
                "497": 178,
                "498": 98,
                "499": 30,
                "500": 229,
                "501": 227,
                "502": 2,
                "503": 223,
                "504": 85,
                "505": 91,
                "506": 154,
                "507": 183,
                "508": 66,
                "509": 114,
                "510": 224,
                "511": 105,
                "512": 249,
                "513": 24,
                "514": 20,
                "515": 155,
                "516": 61,
                "517": 236,
                "518": 79,
                "519": 18,
                "520": 34,
                "521": 139,
                "522": 16,
                "523": 192,
                "524": 248,
                "525": 141,
                "526": 227,
                "527": 106,
                "528": 245,
                "529": 138,
                "530": 116,
                "531": 187,
                "532": 68,
                "533": 43,
                "534": 133,
                "535": 174,
                "536": 0,
                "537": 83,
                "538": 100,
                "539": 189,
                "540": 166,
                "541": 112,
                "542": 32,
                "543": 88,
                "544": 252,
                "545": 31,
                "546": 45,
                "547": 135,
                "548": 155,
                "549": 83,
                "550": 1,
                "551": 17,
                "552": 234,
                "553": 96,
                "554": 232,
                "555": 108,
                "556": 99,
                "557": 241,
                "558": 127,
                "559": 165,
                "560": 148,
                "561": 76,
                "562": 200,
                "563": 63,
                "564": 10,
                "565": 162,
                "566": 105,
                "567": 132,
                "568": 139,
                "569": 62,
                "570": 227,
                "571": 136,
                "572": 166,
                "573": 192,
                "574": 158,
                "575": 107,
                "576": 5,
                "577": 149,
                "578": 63,
                "579": 203,
                "580": 184,
                "581": 244,
                "582": 126,
                "583": 131,
                "584": 162,
                "585": 126,
                "586": 0,
                "587": 114,
                "588": 166,
                "589": 60,
                "590": 50,
                "591": 173,
                "592": 100,
                "593": 134,
                "594": 78,
                "595": 146,
                "596": 109,
                "597": 113,
                "598": 18,
                "599": 250,
                "600": 25,
                "601": 151,
                "602": 247,
                "603": 131,
                "604": 150,
                "605": 86,
                "606": 251,
                "607": 179,
                "608": 43,
                "609": 232,
                "610": 247,
                "611": 136,
                "612": 157,
                "613": 15,
                "614": 1,
                "615": 69,
                "616": 81,
                "617": 154,
                "618": 39,
                "619": 175,
                "620": 221,
                "621": 142,
                "622": 70,
                "623": 176,
                "624": 76,
                "625": 164,
                "626": 41,
                "627": 13,
                "628": 133,
                "629": 64,
                "630": 182,
                "631": 52,
                "632": 184,
                "633": 134,
                "634": 22,
                "635": 30,
                "636": 117,
                "637": 136,
                "638": 200,
                "639": 98,
                "640": 153,
                "641": 220,
                "642": 221,
                "643": 100,
                "644": 53,
                "645": 209,
                "646": 103,
                "647": 138,
                "648": 58,
                "649": 111,
                "650": 10,
                "651": 116,
                "652": 130,
                "653": 156,
                "654": 77,
                "655": 211,
                "656": 247,
                "657": 12,
                "658": 53,
                "659": 36,
                "660": 209,
                "661": 221,
                "662": 241,
                "663": 109,
                "664": 120,
                "665": 173,
                "666": 210,
                "667": 27,
                "668": 100,
                "669": 104,
                "670": 97,
                "671": 117,
                "672": 116,
                "673": 104,
                "674": 68,
                "675": 97,
                "676": 116,
                "677": 97,
                "678": 88,
                "679": 196,
                "680": 73,
                "681": 150,
                "682": 13,
                "683": 229,
                "684": 136,
                "685": 14,
                "686": 140,
                "687": 104,
                "688": 116,
                "689": 52,
                "690": 23,
                "691": 15,
                "692": 100,
                "693": 118,
                "694": 96,
                "695": 91,
                "696": 143,
                "697": 228,
                "698": 174,
                "699": 185,
                "700": 162,
                "701": 134,
                "702": 50,
                "703": 199,
                "704": 153,
                "705": 92,
                "706": 243,
                "707": 186,
                "708": 131,
                "709": 29,
                "710": 151,
                "711": 99,
                "712": 65,
                "713": 0,
                "714": 0,
                "715": 0,
                "716": 0,
                "717": 0,
                "718": 0,
                "719": 0,
                "720": 0,
                "721": 0,
                "722": 0,
                "723": 0,
                "724": 0,
                "725": 0,
                "726": 0,
                "727": 0,
                "728": 0,
                "729": 0,
                "730": 0,
                "731": 0,
                "732": 0,
                "733": 0,
                "734": 64,
                "735": 236,
                "736": 58,
                "737": 219,
                "738": 22,
                "739": 123,
                "740": 115,
                "741": 98,
                "742": 124,
                "743": 11,
                "744": 0,
                "745": 207,
                "746": 244,
                "747": 106,
                "748": 41,
                "749": 249,
                "750": 202,
                "751": 71,
                "752": 106,
                "753": 58,
                "754": 209,
                "755": 209,
                "756": 243,
                "757": 172,
                "758": 181,
                "759": 172,
                "760": 43,
                "761": 40,
                "762": 230,
                "763": 31,
                "764": 122,
                "765": 155,
                "766": 134,
                "767": 233,
                "768": 100,
                "769": 181,
                "770": 1,
                "771": 244,
                "772": 209,
                "773": 87,
                "774": 196,
                "775": 229,
                "776": 209,
                "777": 179,
                "778": 114,
                "779": 159,
                "780": 228,
                "781": 220,
                "782": 236,
                "783": 239,
                "784": 36,
                "785": 27,
                "786": 45,
                "787": 159,
                "788": 223,
                "789": 209,
                "790": 245,
                "791": 214,
                "792": 39,
                "793": 125,
                "794": 27,
                "795": 143,
                "796": 115,
                "797": 48,
                "798": 36,
                "799": 165,
                "800": 1,
                "801": 2,
                "802": 3,
                "803": 38,
                "804": 32,
                "805": 1,
                "806": 33,
                "807": 88,
                "808": 32,
                "809": 76,
                "810": 76,
                "811": 91,
                "812": 252,
                "813": 118,
                "814": 191,
                "815": 197,
                "816": 203,
                "817": 26,
                "818": 81,
                "819": 220,
                "820": 70,
                "821": 76,
                "822": 103,
                "823": 244,
                "824": 203,
                "825": 236,
                "826": 171,
                "827": 119,
                "828": 144,
                "829": 99,
                "830": 196,
                "831": 84,
                "832": 9,
                "833": 147,
                "834": 188,
                "835": 195,
                "836": 151,
                "837": 228,
                "838": 114,
                "839": 184,
                "840": 75,
                "841": 34,
                "842": 88,
                "843": 32,
                "844": 41,
                "845": 100,
                "846": 179,
                "847": 87,
                "848": 130,
                "849": 254,
                "850": 107,
                "851": 200,
                "852": 157,
                "853": 124,
                "854": 49,
                "855": 10,
                "856": 98,
                "857": 63,
                "858": 119,
                "859": 233,
                "860": 77,
                "861": 194,
                "862": 239,
                "863": 205,
                "864": 218,
                "865": 147,
                "866": 101,
                "867": 51,
                "868": 204,
                "869": 147,
                "870": 69,
                "871": 30,
                "872": 246,
                "873": 195,
                "874": 159,
                "875": 113
            },
            "clientDataJSON": {
                "0": 123,
                "1": 34,
                "2": 116,
                "3": 121,
                "4": 112,
                "5": 101,
                "6": 34,
                "7": 58,
                "8": 34,
                "9": 119,
                "10": 101,
                "11": 98,
                "12": 97,
                "13": 117,
                "14": 116,
                "15": 104,
                "16": 110,
                "17": 46,
                "18": 99,
                "19": 114,
                "20": 101,
                "21": 97,
                "22": 116,
                "23": 101,
                "24": 34,
                "25": 44,
                "26": 34,
                "27": 99,
                "28": 104,
                "29": 97,
                "30": 108,
                "31": 108,
                "32": 101,
                "33": 110,
                "34": 103,
                "35": 101,
                "36": 34,
                "37": 58,
                "38": 34,
                "39": 75,
                "40": 71,
                "41": 68,
                "42": 70,
                "43": 117,
                "44": 105,
                "45": 114,
                "46": 75,
                "47": 77,
                "48": 45,
                "49": 50,
                "50": 71,
                "51": 115,
                "52": 103,
                "53": 80,
                "54": 55,
                "55": 70,
                "56": 115,
                "57": 122,
                "58": 110,
                "59": 110,
                "60": 83,
                "61": 57,
                "62": 78,
                "63": 75,
                "64": 51,
                "65": 115,
                "66": 68,
                "67": 57,
                "68": 84,
                "69": 108,
                "70": 78,
                "71": 70,
                "72": 69,
                "73": 113,
                "74": 109,
                "75": 112,
                "76": 118,
                "77": 65,
                "78": 108,
                "79": 106,
                "80": 98,
                "81": 119,
                "82": 34,
                "83": 44,
                "84": 34,
                "85": 111,
                "86": 114,
                "87": 105,
                "88": 103,
                "89": 105,
                "90": 110,
                "91": 34,
                "92": 58,
                "93": 34,
                "94": 104,
                "95": 116,
                "96": 116,
                "97": 112,
                "98": 58,
                "99": 47,
                "100": 47,
                "101": 108,
                "102": 111,
                "103": 99,
                "104": 97,
                "105": 108,
                "106": 104,
                "107": 111,
                "108": 115,
                "109": 116,
                "110": 58,
                "111": 56,
                "112": 56,
                "113": 56,
                "114": 56,
                "115": 34,
                "116": 125
            },
            "username": "Firehed"
        }
        JSON;
        $data = json_decode($json, true, flags: JSON_THROW_ON_ERROR);

        $parser = new ResponseParser();
        $response = $parser->parseCreateResponse($data);

        $cred = $response->verify(
            $this->challenge,
            $this->rp,
        );

        self::assertSame(0, $cred->getSignCount());
        // Look for a specific id and public key?
    }
}
